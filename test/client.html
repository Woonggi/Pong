<!DOCTYPE html>
<html lang="en">
<head>
    <meat charset="utf-8"></meat>
    <title>Pong</title>
    <style>
        canvas {
            position: absolute;
            margin: auto;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>
<body>

<script src="/socket.io/socket.io.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    const socket = io(); 
    let WIDTH = 700, HEIGHT = 600, pi = Math.PI;
    const UP = 38, DOWN = 40;
    
    let canvas, ctx, keystate;
    let ball;
    let win_text = "";

    // send key code to server.
    $('body').on('keydown', (e) => {
        socket.emit('keydown', e.keyCode);
    });

    $('body').on('keyup', (e) => {
        socket.emit('keyup', e.keyCode);
    });

    let players = [];
    class player {
        constructor (xpos = 0, ypos = 0) {
            this.x = xpos;
            this.y = ypos;
            this.width = 20
            this.height = 100;
        }
        update() {
            // console.log('player update');
        }

        draw() {
            ctx.fillRect(this.x, this.y, this.width, this.height);
        }
    }

    ball = {
        x: null,
        y: null,
        vel: null,
        side: 20,
        speed: 5,
        update: function () {
        },

        draw: function() {
            ctx.fillRect(this.x, this.y, this.side, this.side);
        }
    };

    function main() {
        canvas = document.createElement("canvas");
        canvas.width = WIDTH;
        canvas.height = HEIGHT;
        ctx = canvas.getContext("2d");
        document.body.appendChild(canvas);

        init();

        var loop = function() {
            update();
            draw();
            window.requestAnimationFrame(loop, canvas);
        }
        window.requestAnimationFrame(loop, canvas);
    }

    function init() {
        ball.x = (WIDTH - ball.side) / 2;
        ball.y = (HEIGHT - ball.side) / 2;
        ball.vel = {
            x: ball.speed,
            y: 0
        };
    }
    
    function update() {
        //ball.update();
        for(p in players) {
            players[p].update();
        }
    }

    function draw() {
        ctx.fillRect(0, 0, WIDTH, HEIGHT);
        ctx.save();
        ctx.fillStyle = "#fff";

        for(p in players){
            players[p].draw();
        }
        ball.draw();

        var mid_width = 4;
        var x = (WIDTH - mid_width) * 0.5;
        var y = 0;
        var step = HEIGHT / 20;

        // draw half line
        while (y < HEIGHT) {
            ctx.fillRect(x, y + step * 0.25, mid_width, step * 0.5);
            y += step;
        }

        ctx.font = "30px Arial";
        ctx.fillText(win_text, 10, 100);

        ctx.restore();
    }

    main();

    socket.on('setup', (setup) => {
        WIDTH = setup.width;
        HEIGHT = setup.height;
    })
    socket.on('game_over', (win_msg) => {
        win_text = win_msg;
    }) 

    // update game info
    socket.on('update', (ids, player_status, ball_status) => {
        players = [];
        for (id of ids) {
            if(players[id] == null || players[id] == undefined) { 
                players[id] = new player(player_status[id].x, player_status[id].y);
            }
            else {
                players[id].x = player_status[id].x;
                players[id].y = player_status[id].y;
            }
        }
        ball.x = ball_status.x
        ball.y = ball_status.y
    });

</script>
</body>
</html>